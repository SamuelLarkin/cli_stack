version: "3"

env:
  BASH_COMPLETION_D: "{{.HOME}}/.local/share/bash-completion/completions"
  BIN_DIR: "{{.HOME}}/.local/bin"
  INSTALL_DIR: "{{.HOME}}/.local"

tasks:
  default:
    deps:
      - install_plugins
      - plugin_manager
      - shell_completion

  install_plugins:
    desc: >
      Install tmux's plugins.
    summary: |
      Install tmux's plugins.
    cmd: "{{.HOME}}/.tmux/plugins/tpm/bin/install_plugins"
    deps:
      - plugin_manager

  plugin_manager:
    desc: >
      Install tmux's plugin manager.
    summary: |
      Install tmux's plugin manager.

      [tmux plugin manager](https://github.com/tmux-plugins/tpm)
    cmd: |
      git \
         clone \
         https://github.com/tmux-plugins/tpm \
         {{.HOME}}/.tmux/plugins/tpm \
      || ( cd {{.HOME}}/.tmux/plugins/tpm && git pull; )

  shell_completion:
    desc: >
      Install tmux shell completion.
    summary: |
      Install tmux shell completion.

      [tmux shell completion](https://gthub.com/imomaliev/tmux-bash-completion)
    cmd: |
      curl \
         --create-dirs --fail --location \
         --output {{.BASH_COMPLETION_D}}/'#1' \
         'https://raw.githubusercontent.com/imomaliev/tmux-bash-completion/master/completions/{tmux}'

  libevent:
    desc: >
      The libevent API provides a mechanism to execute a callback function when
      a specific event occurs on a file descriptor or after a timeout has been
      reached. Furthermore, libevent also support callbacks due to signals or
      regular timeouts.
    summary: |
      The libevent API provides a mechanism to execute a callback function when
      a specific event occurs on a file descriptor or after a timeout has been
      reached. Furthermore, libevent also support callbacks due to signals or
      regular timeouts.

      [libevent](https://libevent.org/)
    cmds:
      - |
        curl \
          --create-dirs --fail --location \
          --output $TARBALL \
          "https://github.com/libevent/libevent/releases/download/release-$VERSION/libevent-$VERSION.tar.gz"
      - defer: rm $TARBALL
      - mkdir -p libevent
      - defer: rm -fr libevent
      - tar xf $TARBALL --directory=libevent --strip-components=1
      - |
        cd libevent
        ./configure --prefix="{{.INSTALL_DIR}}" --enable-shared
        \make -j $(nproc) install
    dir: "{{.HOME}}/tmp"
    env:
      TARBALL: libevent.tar.gz
      VERSION: 2.1.12-stable
    preconditions:
      - msg: "make must be in your $PATH"
        sh: command -v make

  ncurses:
    desc: >
      [ncurses](https://invisible-island.net/ncurses/)
    summary: |
      [ncurses](https://invisible-island.net/ncurses/)
    cmds:
      - |
        curl \
          --create-dirs --fail --location \
          --output $TARBALL \
          "https://ftp.gnu.org/gnu/ncurses/ncurses-$VERSION.tar.gz"
      - defer: rm $TARBALL
      - mkdir -p ncurses
      - defer: rm -fr ncurses
      - tar xf $TARBALL --directory=ncurses --strip-components=1
      - |
        cd ncurses
        ./configure --prefix="{{.INSTALL_DIR}}" --with-shared --with-termlib --enable-pc-files --with-pkg-config-libdir={{.INSTALL_DIR}}/lib/pkgconfig
        \make -j $(nproc) install
    dir: "{{.HOME}}/tmp"
    env:
      TARBALL: ncurses.tar.gz
      VERSION: 6.5
    preconditions:
      - msg: "make must be in your $PATH"
        sh: command -v make

  tmux:
    desc: >
      A terminal multiplexer.
    summary: |
      A terminal multiplexer.

      [tmux](https://github.com/tmux/tmux)
    cmds:
      - |
        curl \
          --create-dirs --fail --location \
          --output $TARBALL \
          "https://github.com/tmux/tmux/releases/download/$VERSION/tmux-$VERSION.tar.gz"
      - defer: rm $TARBALL
      - mkdir -p tmux
      - defer: rm -fr tmux
      - tar xf $TARBALL --directory=tmux --strip-components=1
      - |
        cd tmux
        PKG_CONFIG_PATH={{.INSTALL_DIR}}/lib/pkgconfig ./configure --prefix="{{.INSTALL_DIR}}" --enable-static
        \make -j $(nproc) install
    deps: [libevent, ncurses]
    dir: "{{.HOME}}/tmp"
    env:
      TARBALL: tmux.tar.gz
      VERSION: 3.5a
    generates:
      - "{{.BIN_DIR}}/tmux"
    status:
      - command -v tmux
    preconditions:
      - msg: "make must be in your $PATH"
        sh: command -v make
      - msg: "yacc must be in your $PATH"
        sh: command -v yacc
