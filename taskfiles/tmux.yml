version: "3"

env:
  BASH_COMPLETION_D: "{{.HOME}}/.local/share/bash-completion/completions"
  BIN_DIR: "{{.HOME}}/.local/bin"
  INSTALL_DIR: "{{.HOME}}/.local"

tasks:
  default:
    deps:
      - install_plugins
      - plugin_manager
      - shell_completion

  install_plugins:
    desc: >
      Install tmux's plugins.
    cmd: "{{.HOME}}/.tmux/plugins/tpm/bin/install_plugins"
    deps:
      - plugin_manager

  plugin_manager:
    desc: >
      Install tmux's plugin manager.
    cmd: |
      git \
         clone \
         https://github.com/tmux-plugins/tpm \
         {{.HOME}}/.tmux/plugins/tpm \
      || ( cd {{.HOME}}/.tmux/plugins/tpm && git pull; )

  shell_completion:
    desc: >
      Install tmux shell completion.
    cmd: |
      curl \
         --create-dirs --fail --location \
         --output {{.BASH_COMPLETION_D}}/'#1' \
         'https://raw.githubusercontent.com/imomaliev/tmux-bash-completion/master/completions/{tmux}'

  tmux:
    desc: >
      [tmux - GitHub](https://github.com/tmux/tmux):
      A terminal multiplexer.
    cmds:
      - |
        curl \
          --create-dirs --fail --location \
          --output "tmux-$VERSION.tar.gz" \
          "https://github.com/tmux/tmux/releases/download/$VERSION/tmux-$VERSION.tar.gz"
      - tar xf tmux-$VERSION.tar.gz
      - defer: rm -fr tmux-$VERSION
      - |
        cd tmux-$VERSION
        ./configure --prefix="{{.INSTALL_DIR}}" --enable-static
        \make -j $(nproc) install
    dir: "{{.HOME}}/tmp"
    env:
      VERSION: 3.5a
    generates:
      - "{{.BIN_DIR}}/tmux"
    status:
      - which tmux
    preconditions:
      - msg: "make must be in your $PATH"
        sh: which make
      - msg: "yacc must be in your $PATH"
        sh: which yacc
